<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PrimeFit v4</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --modal: #334155;
            --text: #f8fafc; --text-light: #94a3b8;
            --accent: #3b82f6; --accent-dark: #1d4ed8;
            --success: #10b981; --danger: #ef4444; --warn: #f59e0b;
            --border: #334155;
            --ring-move: #fa114f; --ring-ex: #a2ff00; --ring-stand: #00f5ea;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; overflow-x: hidden; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }

        /* TYPOGRAPHY */
        h1 { font-size: 1.8rem; font-weight: 800; margin: 0 0 5px 0; letter-spacing: -0.5px; }
        h2 { font-size: 1.4rem; font-weight: 700; margin: 15px 0 10px 0; color:white; }
        h3 { font-size: 1.1rem; font-weight: 600; color: var(--text-light); margin-bottom: 5px; }
        p { color: var(--text-light); line-height: 1.6; margin-top: 0; }
        small { font-size: 0.8rem; color: var(--text-light); }

        /* UI ELEMENTS */
        .card { background: var(--card); border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); border: 1px solid var(--border); margin-bottom: 15px; }
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; transition:0.2s; }
        .btn-primary { background: var(--text); color: var(--bg); }
        .btn-accent { background: var(--accent); color: white; }
        .btn-ghost { background: rgba(255,255,255,0.05); color: var(--text-light); }
        .std-input { width: 100%; padding: 12px; border: 1px solid var(--border); background: var(--bg); color:white; border-radius: 8px; font-size: 1rem; margin-bottom: 10px; }

        /* DASHBOARD & RINGS */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .rings-mini { display:flex; gap:10px; margin-top:10px; }
        .ring-pill { flex:1; padding:8px; border-radius:8px; font-weight:bold; text-align:center; color:black; font-size:0.8rem;}
        
        /* LIBRARY & LOG STYLE */
        .lib-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .lib-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; cursor: pointer; transition: transform 0.1s; display:flex; justify-content:space-between; align-items:center; }
        .lib-card:active { transform: scale(0.98); background: var(--border); }
        .tag { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; margin-right:5px; }
        .tag-muscle { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .tag-type { background: rgba(16, 185, 129, 0.2); color: #34d399; }

        /* JOURNAL ROWS */
        .log-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--card); border-bottom: 1px solid var(--border); cursor: pointer; }
        .log-row:first-child { border-top-left-radius: 16px; border-top-right-radius: 16px; }
        .log-row:last-child { border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; border-bottom: none; }
        .log-date { font-weight: bold; font-size: 0.9rem; }
        .log-stats { display: flex; gap: 8px; font-size: 0.8rem; color: var(--text-light); }

        /* PROGRESS HISTORY LIST */
        .hist-item { border-left: 4px solid var(--border); padding-left: 15px; margin-bottom: 20px; }
        .hist-grade { display:inline-block; padding:4px 8px; border-radius:5px; font-weight:bold; font-size:0.8rem; margin-bottom:5px; color:black;}
        .hist-changes { font-size: 0.85rem; color: var(--text-light); margin-top: 5px; font-style: italic; }

        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: flex; align-items: end; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal-sheet { background: var(--modal); width: 100%; max-height: 85vh; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 25px; overflow-y: auto; transform: translateY(100%); transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .modal-overlay.open .modal-sheet { transform: translateY(0); }
        .detail-stat { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; text-align: center; }

        /* FULL PAGE SLIDE-IN (WORKOUT VIEW) */
        .slide-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 300;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; overflow-y: auto;
        }
        .slide-page.open { transform: translateX(0); }
        .slide-header {
            padding: 15px 20px; background: var(--card); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; position: sticky; top: 0; z-index: 10;
        }

        /* NAV */
        .nav { position: fixed; bottom: 0; width: 100%; height: 80px; background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: space-around; z-index: 50; }
        .nav-btn { flex: 1; border: none; background: none; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-light); font-size: 0.75rem; font-weight: 600; }
        .nav-btn.active { color: var(--accent); }
        .nav-btn i { font-size: 1.5rem; margin-bottom: 4px; }
        
        /* UTILS */
        .timer-big { font-size: 5rem; font-weight: 900; text-align: center; color: var(--text); font-variant-numeric: tabular-nums; margin: 20px 0; }
        .cue-box { background: rgba(245, 158, 11, 0.1); border-left: 4px solid var(--warn); padding: 15px; margin: 15px 0; border-radius: 0 8px 8px 0; }
    </style>
</head>
<body>

    <div id="view-onboarding" class="container hidden" style="height:100vh; display:flex; flex-direction:column; justify-content:center;">
        <h1 style="text-align:center; color:var(--accent);">PRIME<span style="color:white">FIT</span></h1>
        <p style="text-align:center; margin-bottom:30px;">High-intensity programming & Data tracking.</p>
        <label><b>First Name</b></label>
        <input type="text" id="inp-name" class="std-input" placeholder="Name">
        <label><b>Current Weight (lbs)</b></label>
        <input type="number" id="inp-weight" class="std-input" placeholder="175">
        <button class="btn btn-accent" onclick="finishOnboarding()">Generate Plan</button>
    </div>

    <div id="view-dashboard" class="container">
        <div class="header">
            <div>
                <h1 id="dash-greeting">Hello</h1>
                <p id="dash-date">Date</p>
            </div>
            <div style="background:var(--accent); color:white; width:45px; height:45px; border-radius:50%; display:flex; align-items:center; justify-content:center;"><i class="fas fa-bolt"></i></div>
        </div>

        <div id="sunday-card" class="card hidden" style="border: 2px solid var(--warn);">
            <div style="text-align:center; padding-bottom:15px; border-bottom:1px solid var(--border); margin-bottom:15px;">
                <h2 style="margin:0; border:none; color:var(--warn);">Review Pending</h2>
                <p style="margin:0; font-size:0.9rem;">Submit last week's results to unlock.</p>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
                <div class="score-circle" style="width:100px; height:100px; margin:0 auto; border: 6px solid var(--accent); border-radius:50%; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                    <span class="score-val" id="week-adherence" style="font-size:1.8rem; font-weight:900; color:var(--accent);">0%</span>
                    <span style="font-size:0.6rem; font-weight:bold; text-transform:uppercase;">Adherence</span>
                </div>
                <div class="score-circle" style="width:100px; height:100px; margin:0 auto; border: 6px solid var(--ring-move); border-radius:50%; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                    <span class="score-val" id="week-move-avg" style="font-size:1.8rem; font-weight:900; color:var(--ring-move);">0</span>
                    <span style="font-size:0.6rem; font-weight:bold; text-transform:uppercase;">Avg Move</span>
                </div>
            </div>
            <div id="sunday-feedback" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin-bottom:15px; font-size:0.9rem;"></div>
            <div id="sunday-input-group">
                <input type="number" id="sunday-weight" class="std-input" placeholder="Current Weight (lbs)">
                <button class="btn btn-accent" onclick="processWeeklyAnalysis()">Submit & Generate Next Week</button>
            </div>
        </div>

        <div id="normal-dash">
            <div class="card" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0; color:white;"><i class="fab fa-apple"></i> Watch Targets</h3>
                </div>
                <div class="rings-mini">
                    <div class="ring-pill" style="background:var(--ring-move);" id="goal-move">600</div>
                    <div class="ring-pill" style="background:var(--ring-ex);" id="goal-ex">45</div>
                    <div class="ring-pill" style="background:var(--ring-stand);" id="goal-stand">12</div>
                </div>
            </div>

            <div class="card" id="today-card"></div>

            <div class="card" id="quick-log-card">
                <h3><i class="fas fa-history"></i> Log Yesterday's Rings</h3>
                <div style="display:flex; gap:5px;">
                    <input type="number" id="log-move" class="std-input" placeholder="Move" style="margin:0; flex:1; border-color:var(--ring-move);">
                    <input type="number" id="log-ex" class="std-input" placeholder="Ex" style="margin:0; flex:1; border-color:var(--ring-ex);">
                    <input type="number" id="log-stand" class="std-input" placeholder="Stand" style="margin:0; flex:1; border-color:var(--ring-stand);">
                </div>
                <button class="btn btn-ghost" style="margin-top:10px;" onclick="logRingsQuick()">Save Data</button>
            </div>
        </div>
    </div>

    <div id="view-schedule" class="container hidden">
        <h1>Schedule</h1>
        <div class="card" id="week-list" style="margin-top:10px; padding:0;"></div>
    </div>

    <div id="view-progress" class="container hidden">
        <h1>Progress</h1>
        <div class="card">
            <h3 style="margin-top:0;">Weight Trend</h3>
            <canvas id="weight-chart"></canvas>
        </div>
        
        <h2>Weekly Report History</h2>
        <div id="history-list">
            <p style="color:var(--text-light); text-align:center;">No weekly reports yet.</p>
        </div>
    </div>

    <div id="view-journal" class="container hidden">
        <h1>Daily Log</h1>
        <p>Tap a day to edit details.</p>
        <div id="journal-list" style="margin-top:20px;"></div>
    </div>

    <div id="view-library" class="container hidden">
        <h1>Exercise Database</h1>
        <div class="lib-grid" id="lib-list" style="margin-top:20px;"></div>
    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="switchTab('dashboard')"><i class="fas fa-bolt"></i>Today</button>
        <button class="nav-btn" onclick="switchTab('schedule')"><i class="fas fa-calendar-day"></i>Plan</button>
        <button class="nav-btn" onclick="switchTab('progress')"><i class="fas fa-chart-line"></i>Progress</button>
        <button class="nav-btn" onclick="switchTab('journal')"><i class="fas fa-book"></i>Log</button>
        <button class="nav-btn" onclick="switchTab('library')"><i class="fas fa-dumbbell"></i>Guide</button>
    </div>

    <div id="modal-ex" class="modal-overlay" onclick="closeModal('modal-ex')">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content:space-between; align-items:start;">
                <h1 id="mod-title" style="margin:0;">Exercise</h1>
                <button class="btn-outline" style="width:auto; padding:5px 10px; border-radius:50%;" onclick="closeModal('modal-ex')"><i class="fas fa-times"></i></button>
            </div>
            <div id="mod-tags" style="margin:10px 0;"></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
                <div class="detail-stat">
                    <div style="font-size:0.7rem; color:var(--text-light); text-transform:uppercase;">Breathing</div>
                    <div id="mod-breath" style="font-size:0.9rem; font-weight:bold;">-</div>
                </div>
            </div>
            <h3>Technique</h3>
            <p id="mod-desc" style="font-size:0.95rem; color:white;"></p>
            <div class="cue-box">
                <strong style="color:var(--warn);">Key Cues</strong>
                <ul id="mod-steps" style="padding-left:20px; margin:5px 0; color:var(--text-light); font-size:0.9rem;"></ul>
            </div>
        </div>
    </div>

    <div id="modal-edit" class="modal-overlay" onclick="closeModal('modal-edit')">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <h2 id="edit-date-title">Edit Date</h2>
            <input type="hidden" id="edit-date-val">
            
            <label style="font-weight:bold; font-size:0.8rem; color:var(--text-light);">APPLE WATCH RINGS</label>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input type="number" id="edit-move" class="std-input" style="border-color:var(--ring-move);" placeholder="Move">
                <input type="number" id="edit-ex" class="std-input" style="border-color:var(--ring-ex);" placeholder="Ex">
                <input type="number" id="edit-stand" class="std-input" style="border-color:var(--ring-stand);" placeholder="Stand">
            </div>

            <label style="font-weight:bold; font-size:0.8rem; color:var(--text-light);">BODY WEIGHT</label>
            <input type="number" id="edit-weight" class="std-input" placeholder="Lbs">

            <button class="btn btn-accent" onclick="saveDayEdit()">Save Changes</button>
            <button class="btn btn-ghost" onclick="closeModal('modal-edit')" style="margin-top:10px;">Cancel</button>
        </div>
    </div>

    <div id="view-active" class="slide-page">
        <div class="slide-header">
            <button class="btn-ghost" style="width:auto; padding:8px; border-radius:50%; margin-right:15px;" onclick="quitWorkout()">
                <i class="fas fa-arrow-left" style="font-size:1.2rem; color:var(--text);"></i>
            </button>
            <div>
                <strong id="act-routine" style="display:block; font-size:1.1rem;">Routine Name</strong>
                <small id="act-sub" style="color:var(--text-light);">In Progress</small>
            </div>
        </div>
        
        <div style="padding:20px; padding-bottom:100px;">
            <div style="text-align:center;">
                <span style="background:var(--border); padding:5px 10px; border-radius:15px; font-size:0.8rem;">Set <span id="act-idx">1</span></span>
                <h1 id="act-name" style="margin-top:10px; font-size:2.2rem;">Name</h1>
            </div>
            
            <div id="act-viz"></div>
            
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin:20px 0; text-align:center;">
                <div style="font-size:0.8rem; color:var(--text-light); margin-bottom:5px;">BREATHING PATTERN</div>
                <div id="act-breath-disp" style="font-weight:bold; font-size:1.1rem; color:var(--accent-light);"></div>
            </div>
            
            <div class="cue-box">
                <ul id="act-cues" style="padding-left:20px; margin:0; color:var(--text);"></ul>
            </div>
            
            <button class="btn btn-success" id="act-btn" style="margin-top:20px; padding:20px; font-size:1.2rem;" onclick="nextExercise()">Start</button>
        </div>
    </div>

    <script>
        /* --- 1. DATA --- */
        const library = {
            "Burpees": {
                desc: "The ultimate full-body metabolic conditioning tool. Combines a squat, push-up, and jump.",
                muscles: ["Chest", "Quads", "Core"],
                type: "reps", val: 15, tempo: "Explosive", breath: "Inhale drop, Exhale jump",
                steps: ["Squat, hands to floor.", "Jump feet back to plank.", "Drop chest to floor.", "Snap feet to hands.", "Jump vertical & clap."]
            },
            "Jump Squats": {
                desc: "Plyometric squat to develop lower body power.",
                muscles: ["Quads", "Glutes"],
                type: "reps", val: 20, tempo: "Fast Up, Control Down", breath: "Inhale down, Exhale jump",
                steps: ["Squat depth below parallel.", "Explode up vertically.", "Land softly.", "Recoil immediately."]
            },
            "Diamond Push-ups": {
                desc: "Close-grip push-up emphasizing triceps.",
                muscles: ["Triceps", "Inner Chest"],
                type: "reps", val: 15, tempo: "2s Down, 1s Up", breath: "Inhale down, Exhale push",
                steps: ["Hands in diamond shape.", "Elbows tucked.", "Chest to hands.", "Lock out."]
            },
            "Mountain Climbers": {
                desc: "Horizontal running for core stability.",
                muscles: ["Core", "Cardio"],
                type: "time", val: 45, tempo: "Max Speed", breath: "Rhythmic breathing",
                steps: ["High plank position.", "Drive knee to chest.", "Switch rapidly.", "Keep hips level."]
            },
            "Hollow Body Hold": {
                desc: "Isometric core strength.",
                muscles: ["Abs"],
                type: "time", val: 60, tempo: "Static", breath: "Short sips",
                steps: ["Lie on back.", "Lift shoulders & legs.", "Press lower back to floor.", "Banana shape."]
            },
            "Walking Lunges": {
                desc: "Unilateral leg training.",
                muscles: ["Glutes", "Quads"],
                type: "reps", val: 24, tempo: "Controlled", breath: "Inhale step, Exhale drive",
                steps: ["Step forward.", "Back knee taps floor.", "Drive through heel.", "Torso upright."]
            },
            "High Knees": {
                desc: "Sprint in place.",
                muscles: ["Cardio"],
                type: "time", val: 60, tempo: "Sprint", breath: "Rhythmic",
                steps: ["Knees to hip height.", "Pump arms.", "Stay on toes."]
            }
        };

        const routines = {
            'HIIT A': { type: 'Cardio', duration: 25, exercises: ["High Knees", "Burpees", "Mountain Climbers", "High Knees", "Burpees"] },
            'Power B': { type: 'Strength', duration: 30, exercises: ["Jump Squats", "Diamond Push-ups", "Walking Lunges", "Diamond Push-ups", "Hollow Body Hold"] },
            'Metcon C': { type: 'Hybrid', duration: 20, exercises: ["Burpees", "Jump Squats", "Mountain Climbers", "Walking Lunges", "Hollow Body Hold"] }
        };

        /* --- 2. STATE --- */
        let appState = {
            user: { name: "", startWeight: 0, currentWeight: 0, goals: {m:0, e:0, s:0} },
            weekPlan: [],
            pendingReview: false, // LOCK MECHANISM
            logs: [],
            ringLogs: [],
            weightHistory: [],
            pastWeeks: [], // Stores {date, grade, summary, changes}
            onboarded: false
        };
        
        let audioCtx = null, timer = null, activeR = null, actIdx = 0, timerVal = 0, isPaused = false;
        let weightChart = null;

        /* --- 3. INIT --- */
        window.onload = () => {
            const saved = localStorage.getItem('PrimeFit_v4');
            if(saved) appState = JSON.parse(saved);

            if(!appState.onboarded) document.getElementById('view-onboarding').classList.remove('hidden');
            else {
                checkWeeklyPlan();
                initApp();
            }
        };

        function save() { localStorage.setItem('PrimeFit_v4', JSON.stringify(appState)); }

        function finishOnboarding() {
            const n = document.getElementById('inp-name').value;
            const w = parseFloat(document.getElementById('inp-weight').value);
            if(!n||!w) return alert("Required");
            
            appState.user.name = n;
            appState.user.startWeight = w;
            appState.user.currentWeight = w;
            appState.weightHistory.push({date: new Date().toISOString(), weight: w});
            appState.user.goals = { m: Math.round(w * 4.5), e: 45, s: 12 };
            appState.onboarded = true;
            generateWeek();
            save();
            document.getElementById('view-onboarding').classList.add('hidden');
            initApp();
        }

        function generateWeek() {
            const plan = [];
            const today = new Date();
            const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            // Generates 7 days starting TODAY
            for(let i=0; i<7; i++) {
                let d = new Date();
                d.setDate(today.getDate() + i);
                let dayNum = d.getDay();
                let rKey = null;
                if(dayNum === 1 || dayNum === 4) rKey = 'HIIT A';
                else if(dayNum === 2 || dayNum === 5) rKey = 'Power B';
                else if(dayNum === 3 || dayNum === 6) rKey = 'Metcon C';
                plan.push({
                    date: d.toISOString().split('T')[0],
                    dayName: days[dayNum],
                    routineKey: rKey,
                    completed: false
                });
            }
            appState.weekPlan = plan;
            appState.pendingReview = false; 
        }

        function checkWeeklyPlan() {
            if(!appState.weekPlan.length) return generateWeek();
            
            const lastDate = new Date(appState.weekPlan[6].date);
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const lastDateStr = lastDate.toISOString().split('T')[0];

            // If today is AFTER the last plan date
            if(today > lastDate && todayStr !== lastDateStr) {
                appState.pendingReview = true;
                save();
            }
        }

        function initApp() {
            document.getElementById('dash-greeting').innerText = `What's good, ${appState.user.name}`;
            document.getElementById('dash-date').innerText = new Date().toDateString();
            document.getElementById('goal-move').innerText = appState.user.goals.m;
            document.getElementById('goal-ex').innerText = appState.user.goals.e;
            document.getElementById('goal-stand').innerText = appState.user.goals.s;

            renderDashboard();
            renderSchedule();
            renderLibrary();
            renderJournal();
            renderProgress(); // New call
        }

        function switchTab(t) {
            document.querySelectorAll('.container').forEach(c=>c.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById(`view-${t}`).classList.remove('hidden');
            
            const map = {'dashboard':0, 'schedule':1, 'progress':2, 'journal':3, 'library':4};
            document.querySelectorAll('.nav-btn')[map[t]].classList.add('active');
            
            if(t === 'progress') renderProgress();
            if(t === 'journal') renderJournal();
        }

        /* --- DASHBOARD LOGIC --- */
        function renderDashboard() {
            const todayStr = new Date().toISOString().split('T')[0];
            const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
            const yestStr = yesterday.toISOString().split('T')[0];

            // 1. Conditional Quick Log
            const hasYesterday = appState.ringLogs.find(l => l.date.startsWith(yestStr));
            if(hasYesterday) document.getElementById('quick-log-card').classList.add('hidden');
            else document.getElementById('quick-log-card').classList.remove('hidden');

            // 2. Lockout / Sunday Logic
            if(appState.pendingReview) {
                // FORCE THE REVIEW
                document.getElementById('normal-dash').classList.add('hidden');
                document.getElementById('sunday-card').classList.remove('hidden');
                prepareSundayReport();
            } else {
                document.getElementById('normal-dash').classList.remove('hidden');
                document.getElementById('sunday-card').classList.add('hidden');

                const task = appState.weekPlan.find(d => d.date === todayStr);
                const container = document.getElementById('today-card');
                
                if(!task || !task.routineKey) {
                    container.innerHTML = `<h2>Active Recovery</h2><p>Hit your Move goal today.</p>`;
                } else if(task.completed) {
                    container.innerHTML = `<div style="text-align:center; padding:20px;"><i class="fas fa-check-circle" style="font-size:4rem; color:var(--success);"></i><h2>Done.</h2></div>`;
                } else {
                    const r = routines[task.routineKey];
                    container.innerHTML = `
                        <h3 style="text-transform:uppercase; font-size:0.8rem;">MISSION</h3>
                        <h2 style="margin-top:5px; border:none;">${task.routineKey}</h2>
                        <p>${r.exercises.length} Exercises • ${r.duration} Mins</p>
                        <button class="btn btn-accent" onclick="startWorkout('${task.routineKey}')">Start Workout</button>
                    `;
                }
            }
        }

        /* --- REVIEW & PROGRESS --- */
        function prepareSundayReport() {
            const scheduled = appState.weekPlan.filter(d => d.routineKey).length;
            const done = appState.weekPlan.filter(d => d.completed).length;
            const score = scheduled === 0 ? 100 : Math.round((done/scheduled)*100);
            
            document.getElementById('week-adherence').innerText = score + "%";
            document.getElementById('week-adherence').dataset.val = score;

            const recentRings = appState.ringLogs.slice(-7);
            let avgMove = recentRings.length ? Math.round(recentRings.reduce((a,b)=>a+b.m,0)/recentRings.length) : 0;
            document.getElementById('week-move-avg').innerText = avgMove;
            document.getElementById('week-move-avg').dataset.val = avgMove;

            let msg = score >= 80 && avgMove > appState.user.goals.m ? "Great work. Goals will likely increase." : "Consistency slipped. We may adjust goals down.";
            document.getElementById('sunday-feedback').innerText = msg;
        }

        function processWeeklyAnalysis() {
            const wInput = document.getElementById('sunday-weight');
            if(!wInput.value) return alert("Log weight to proceed.");
            
            const weightVal = parseFloat(wInput.value);
            appState.user.currentWeight = weightVal;
            appState.weightHistory.push({date: new Date().toISOString(), weight: weightVal});

            const score = parseInt(document.getElementById('week-adherence').dataset.val);
            const avgMove = parseInt(document.getElementById('week-move-avg').dataset.val);
            const oldGoals = {...appState.user.goals};
            let changesTxt = "Goals Maintained";
            let grade = "B";
            let gradeColor = "var(--warn)";

            // Optimization Algorithm
            if(score >= 80 && avgMove > oldGoals.m) {
                appState.user.goals.m += 50;
                changesTxt = `Move Goal +50 (High Activity)`;
                grade = "A";
                gradeColor = "var(--success)";
            } else if (score < 40) {
                appState.user.goals.m = Math.max(400, oldGoals.m - 50);
                changesTxt = `Move Goal -50 (Recovery)`;
                grade = "C";
                gradeColor = "var(--danger)";
            }

            if(score >= 90) {
                appState.user.goals.e += 5;
                changesTxt += ", Ex Goal +5m";
            } else if (score < 50) {
                appState.user.goals.e = Math.max(30, oldGoals.e - 5);
                changesTxt += ", Ex Goal -5m";
            }

            // Save to Past Weeks
            const report = {
                weekDate: new Date().toISOString().split('T')[0],
                grade: grade,
                gradeColor: gradeColor,
                changes: changesTxt,
                adherence: score
            };
            
            if(!appState.pastWeeks) appState.pastWeeks = [];
            appState.pastWeeks.unshift(report); // Add to top

            generateWeek(); // Resets pendingReview to false
            save();
            
            alert(`Analysis Complete. Grade: ${grade}. ${changesTxt}`);
            location.reload(); 
        }

        function renderProgress() {
            // 1. Chart
            const ctx = document.getElementById('weight-chart').getContext('2d');
            const data = appState.weightHistory.map(x => ({x: x.date.split('T')[0], y: x.weight}));
            
            if(weightChart) weightChart.destroy();
            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.x),
                    datasets: [{
                        label: 'Weight',
                        data: data.map(d => d.y),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { grid: {color:'#334155'}, ticks:{color:'#94a3b8'} }, x: { display: false } },
                    plugins: { legend: {display:false} }
                }
            });

            // 2. History List
            const list = document.getElementById('history-list');
            if(!appState.pastWeeks || appState.pastWeeks.length === 0) {
                list.innerHTML = `<p style="color:var(--text-light); text-align:center;">No weekly reports yet.</p>`;
                return;
            }
            
            list.innerHTML = "";
            appState.pastWeeks.forEach(w => {
                list.innerHTML += `
                    <div class="hist-item">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:bold;">Week of ${w.weekDate}</span>
                            <span class="hist-grade" style="background:${w.gradeColor}">${w.grade}</span>
                        </div>
                        <div style="font-size:0.8rem;">Adherence: ${w.adherence}%</div>
                        <div class="hist-changes"><i class="fas fa-wrench"></i> ${w.changes}</div>
                    </div>
                `;
            });
        }

        /* --- JOURNAL & QUICK LOG --- */
        function logRingsQuick() {
            const m = parseInt(document.getElementById('log-move').value);
            const e = parseInt(document.getElementById('log-ex').value);
            const s = parseInt(document.getElementById('log-stand').value);
            if(!m || !e || !s) return alert("Fill all rings");
            
            const yest = new Date(); yest.setDate(yest.getDate() - 1);
            appState.ringLogs.push({date: yest.toISOString(), m, e, s});
            save();
            renderDashboard();
        }

        function renderJournal() {
            const list = document.getElementById('journal-list');
            list.innerHTML = "";
            const dates = [];
            for(let i=0; i<30; i++) {
                const d = new Date(); d.setDate(d.getDate() - i);
                dates.push(d.toISOString().split('T')[0]);
            }
            dates.forEach(dateStr => {
                const ringData = appState.ringLogs.find(l => l.date.startsWith(dateStr));
                const weightData = appState.weightHistory.find(w => w.date.startsWith(dateStr));
                
                let ringDisplay = ringData ? 
                    `<span style="color:var(--ring-move)">${ringData.m}</span> / <span style="color:var(--ring-ex)">${ringData.e}</span> / <span style="color:var(--ring-stand)">${ringData.s}</span>` 
                    : "No Data";
                let weightDisplay = weightData ? `• ${weightData.weight} lbs` : "";

                list.innerHTML += `
                    <div class="log-row" onclick="openEditModal('${dateStr}')">
                        <div class="log-date">${dateStr}</div>
                        <div class="log-stats">
                            <div>${ringDisplay} ${weightDisplay}</div>
                            <i class="fas fa-pen" style="margin-left:10px; opacity:0.5;"></i>
                        </div>
                    </div>
                `;
            });
        }

        /* --- MODAL LOGIC (Edit & Detail) --- */
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        
        function openExModal(key) {
            const ex = library[key];
            document.getElementById('mod-title').innerText = key;
            document.getElementById('mod-desc').innerText = ex.desc;
            document.getElementById('mod-breath').innerText = ex.breath;
            document.getElementById('mod-steps').innerHTML = ex.steps.map(s => `<li>${s}</li>`).join('');
            let tagsHtml = `<span class="tag tag-type">${ex.type}</span>`;
            ex.muscles.forEach(m => tagsHtml += `<span class="tag tag-muscle">${m}</span>`);
            document.getElementById('mod-tags').innerHTML = tagsHtml;
            document.getElementById('modal-ex').classList.add('open');
        }

        function openEditModal(dateStr) {
            document.getElementById('edit-date-title').innerText = `Edit: ${dateStr}`;
            document.getElementById('edit-date-val').value = dateStr;
            const ringData = appState.ringLogs.find(l => l.date.startsWith(dateStr));
            const weightData = appState.weightHistory.find(w => w.date.startsWith(dateStr));
            document.getElementById('edit-move').value = ringData ? ringData.m : "";
            document.getElementById('edit-ex').value = ringData ? ringData.e : "";
            document.getElementById('edit-stand').value = ringData ? ringData.s : "";
            document.getElementById('edit-weight').value = weightData ? weightData.weight : "";
            document.getElementById('modal-edit').classList.add('open');
        }

        function saveDayEdit() {
            const dateStr = document.getElementById('edit-date-val').value;
            const m = parseInt(document.getElementById('edit-move').value);
            const e = parseInt(document.getElementById('edit-ex').value);
            const s = parseInt(document.getElementById('edit-stand').value);
            const w = parseFloat(document.getElementById('edit-weight').value);

            if(m && e && s) {
                const idx = appState.ringLogs.findIndex(l => l.date.startsWith(dateStr));
                if(idx >= 0) { appState.ringLogs[idx].m = m; appState.ringLogs[idx].e = e; appState.ringLogs[idx].s = s; } 
                else { appState.ringLogs.push({date: new Date(dateStr).toISOString(), m, e, s}); }
            }
            if(w) {
                const idx = appState.weightHistory.findIndex(x => x.date.startsWith(dateStr));
                if(idx >= 0) appState.weightHistory[idx].weight = w;
                else appState.weightHistory.push({date: new Date(dateStr).toISOString(), weight: w});
                const today = new Date().toISOString().split('T')[0];
                if(dateStr === today) appState.user.currentWeight = w;
            }
            save();
            closeModal('modal-edit');
            renderJournal();
            renderDashboard(); 
        }

        /* --- LIBRARY RENDER --- */
        function renderLibrary() {
            const list = document.getElementById('lib-list');
            list.innerHTML = "";
            for(let key in library) {
                const ex = library[key];
                list.innerHTML += `
                    <div class="lib-card" onclick="openExModal('${key}')">
                        <div>
                            <div style="font-weight:bold; font-size:1.1rem; margin-bottom:5px;">${key}</div>
                            <span class="tag tag-type">${ex.type}</span>
                        </div>
                        <i class="fas fa-chevron-right" style="color:var(--text-light);"></i>
                    </div>
                `;
            }
        }

        /* --- ACTIVE WORKOUT (SLIDE-IN) --- */
        function startWorkout(key) {
            activeR = routines[key];
            actIdx = 0;
            document.getElementById('view-active').classList.add('open');
            document.getElementById('act-routine').innerText = key;
            loadEx();
        }

        function quitWorkout() {
            if(confirm("Abandon workout?")) {
                clearInterval(timer);
                document.getElementById('view-active').classList.remove('open');
            }
        }

        function loadEx() {
            if(actIdx >= activeR.exercises.length) return finishWorkout();
            const name = activeR.exercises[actIdx];
            const data = library[name];
            document.getElementById('act-name').innerText = name;
            document.getElementById('act-idx').innerText = actIdx+1;
            document.getElementById('act-cues').innerHTML = data.steps.map(s=>`<li>${s}</li>`).join('');
            document.getElementById('act-breath-disp').innerText = data.breath;

            const viz = document.getElementById('act-viz');
            const btn = document.getElementById('act-btn');
            clearInterval(timer);

            if(data.type === 'reps') {
                viz.innerHTML = `<div class="timer-big" style="color:var(--accent)">${data.val}<span style="font-size:2rem;color:var(--text-light)">reps</span></div>`;
                btn.innerText = "Complete Set";
                btn.className = "btn btn-success";
                btn.onclick = nextExercise;
            } else {
                timerVal = data.val;
                isPaused = false;
                viz.innerHTML = `<div class="timer-big" id="timer-val">00:${timerVal}</div>`;
                btn.innerText = "Start Timer";
                btn.className = "btn btn-primary";
                btn.onclick = toggleTimer;
            }
        }

        function toggleTimer() {
            const btn = document.getElementById('act-btn');
            if(btn.innerText === "Start Timer") {
                btn.innerText = "Pause";
                if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
                startLoop();
            } else if(btn.innerText === "Pause") { isPaused = true; btn.innerText = "Resume"; } 
            else { isPaused = false; btn.innerText = "Pause"; }
        }

        function startLoop() {
            timer = setInterval(() => {
                if(!isPaused) {
                    timerVal--;
                    document.getElementById('timer-val').innerText = `00:${timerVal.toString().padStart(2,'0')}`;
                    if(timerVal <= 0) {
                        clearInterval(timer);
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.connect(gain); gain.connect(audioCtx.destination);
                        osc.frequency.value = 600; gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+1);
                        osc.start(); osc.stop(audioCtx.currentTime+1);
                        nextExercise();
                    }
                }
            }, 1000);
        }

        function nextExercise() { actIdx++; loadEx(); }
        function finishWorkout() {
            clearInterval(timer);
            document.getElementById('view-active').classList.remove('open');
            const todayStr = new Date().toISOString().split('T')[0];
            const task = appState.weekPlan.find(d => d.date === todayStr);
            if(task) task.completed = true;
            appState.logs.push({date: new Date().toISOString(), duration: 25, type: 'Workout'});
            save();
            renderDashboard();
            alert("Workout Complete.");
        }
    </script>
</body>
</html>
