<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BaseLayer v4: Adaptive</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b;
            --text: #f8fafc; --text-light: #94a3b8;
            --accent: #38bdf8; --accent-dim: rgba(56, 189, 248, 0.1);
            --success: #22c55e; --danger: #ef4444; --warning: #f59e0b;
            --border: #334155;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }

        /* TYPOGRAPHY */
        h1 { font-size: 1.8rem; font-weight: 800; margin: 0 0 5px 0; letter-spacing: -0.5px; }
        h2 { font-size: 1.3rem; font-weight: 700; margin: 20px 0 10px 0; color: var(--text); }
        small { color: var(--text-light); font-size: 0.85rem; }

        /* UI ELEMENTS */
        .card { background: var(--card); border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2); border: 1px solid var(--border); margin-bottom: 20px; }
        
        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 10px; transition: 0.2s; }
        .btn-primary { background: var(--text); color: var(--bg); }
        .btn-accent { background: var(--accent); color: #0f172a; }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text); }
        .btn:active { transform: scale(0.98); }

        .std-input { width: 100%; padding: 15px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; font-size: 1rem; color: white; margin-bottom: 15px; }
        .std-input:focus { outline: none; border-color: var(--accent); }

        /* METRICS GRID */
        .metric-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .metric-box { background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 12px; text-align: center; }
        .metric-val { font-size: 1.4rem; font-weight: 800; color: var(--text); }
        .metric-lbl { font-size: 0.75rem; text-transform: uppercase; color: var(--text-light); font-weight: bold; letter-spacing: 0.5px; }

        /* HABIT ROW */
        .habit-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); cursor: pointer; }
        .habit-row:last-child { border-bottom: none; }
        .habit-check { width: 24px; height: 24px; border-radius: 6px; border: 2px solid var(--text-light); display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .habit-check.checked { background: var(--success); border-color: var(--success); color: white; }

        /* ACTIVE WORKOUT */
        #view-active { position: fixed; inset: 0; background: var(--bg); z-index: 100; overflow-y: auto; }
        .active-content { padding: 20px; min-height: 100vh; display: flex; flex-direction: column; }
        .timer-display { font-size: 5rem; font-weight: 900; text-align: center; margin: 30px 0; font-variant-numeric: tabular-nums; }

        /* NAV */
        .nav { position: fixed; bottom: 0; width: 100%; height: 85px; background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: space-around; z-index: 50; padding-bottom: 15px; }
        .nav-btn { flex: 1; border: none; background: none; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-light); font-size: 0.7rem; font-weight: 600; gap: 5px; }
        .nav-btn.active { color: var(--accent); }
        .nav-btn i { font-size: 1.4rem; }

        /* ONBOARDING OVERLAY (Strict) */
        #view-onboarding { position: fixed; inset: 0; z-index: 200; background: var(--bg); padding: 30px; display: flex; flex-direction: column; justify-content: center; }
    </style>
</head>
<body>

    <div id="view-onboarding" class="hidden">
        <h1 style="text-align:center; color:var(--accent); font-size:2.5rem;">BASE<span style="color:white">LAYER</span></h1>
        <p style="text-align:center; color:var(--text-light); margin-bottom:40px;">Setup your adaptive profile.</p>
        
        <label style="font-weight:bold; font-size:0.9rem;">First Name</label>
        <input type="text" id="inp-name" class="std-input" placeholder="Name">
        
        <label style="font-weight:bold; font-size:0.9rem;">Current Weight (lbs)</label>
        <input type="number" id="inp-weight" class="std-input" placeholder="e.g., 185">
        <p style="font-size:0.8rem; color:var(--text-light); margin-top:-10px; margin-bottom:15px;">Required for calorie algorithm.</p>
        
        <label style="font-weight:bold; font-size:0.9rem;">Daily Step Goal</label>
        <input type="number" id="inp-steps" class="std-input" value="7000">
        
        <button class="btn btn-accent" onclick="finishOnboarding()">Save & Start</button>
        <p id="onboard-error" style="color:var(--danger); text-align:center; display:none;">All fields are required.</p>
    </div>

    <div id="view-dashboard" class="container hidden">
        <div class="header">
            <div>
                <h1 id="dash-greeting">Hello</h1>
                <small id="dash-date">Date</small>
            </div>
            <div onclick="logWeightModal()" style="background:var(--card); border:1px solid var(--border); padding:8px 15px; border-radius:20px; font-weight:bold; font-size:0.9rem;">
                <i class="fas fa-weight-scale"></i> <span id="dash-weight-val">--</span>
            </div>
        </div>

        <div class="metric-grid">
            <div class="metric-box">
                <div class="metric-val" id="dash-cal">0</div>
                <div class="metric-lbl">Est. Cals Burned</div>
            </div>
            <div class="metric-box">
                <div class="metric-val" id="dash-streak">0</div>
                <div class="metric-lbl">Day Streak</div>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 style="margin:0; font-size:1.1rem;">Daily Goals</h2>
                <small id="lbl-steps">Target: 7000</small>
            </div>
            
            <div class="habit-row" onclick="toggleHabit('walk')">
                <div>Walk / Steps</div>
                <div class="habit-check" id="chk-walk"><i class="fas fa-check"></i></div>
            </div>
            <div class="habit-row" onclick="toggleHabit('water')">
                <div>Hydration (3L)</div>
                <div class="habit-check" id="chk-water"><i class="fas fa-check"></i></div>
            </div>
            <div class="habit-row" onclick="toggleHabit('sleep')">
                <div>7+ Hours Sleep</div>
                <div class="habit-check" id="chk-sleep"><i class="fas fa-check"></i></div>
            </div>
        </div>

        <div class="card" id="today-card">
            </div>

        <h2 style="font-size:1rem;">Quick Log</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="btn btn-outline" onclick="quickLog('Walk', 30, 3.5)">
                <i class="fas fa-walking"></i> Walk 30m
            </button>
            <button class="btn btn-outline" onclick="quickLog('Sports', 60, 7.0)">
                <i class="fas fa-basketball-ball"></i> Sports 60m
            </button>
        </div>
    </div>

    <div id="view-schedule" class="container hidden">
        <div class="header"><h1>Schedule</h1></div>
        <div class="card" id="week-list"></div>
    </div>

    <div id="view-library" class="container hidden">
        <div class="header"><h1>Library</h1></div>
        <input type="text" class="std-input" placeholder="Search exercises..." onkeyup="filterLib(this.value)">
        <div id="lib-list" style="padding-bottom:100px;"></div>
    </div>

    <div id="view-active" class="hidden">
        <div class="active-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button class="btn btn-outline" style="width:auto; border:none; color:var(--text-light);" onclick="quitWorkout()">Quit</button>
                <div style="font-weight:bold; color:var(--accent);" id="act-progress">1 / 5</div>
            </div>
            
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center; text-align:center;">
                <span id="act-cat" style="text-transform:uppercase; letter-spacing:2px; font-size:0.8rem; color:var(--text-light);">Category</span>
                <h1 id="act-name" style="font-size:2.5rem; margin:10px 0;">Name</h1>
                <div id="act-viz"></div>
                <p id="act-cue" style="color:var(--accent); background:var(--accent-dim); padding:15px; border-radius:10px; margin-top:20px;"></p>
            </div>

            <button class="btn btn-accent" id="act-btn" style="padding:20px; font-size:1.2rem;" onclick="nextExercise()">Start</button>
        </div>
    </div>

    <div class="nav hidden" id="main-nav">
        <button class="nav-btn active" onclick="switchTab('dashboard')"><i class="fas fa-home"></i><span>Today</span></button>
        <button class="nav-btn" onclick="switchTab('schedule')"><i class="fas fa-calendar"></i><span>Plan</span></button>
        <button class="nav-btn" onclick="switchTab('library')"><i class="fas fa-dumbbell"></i><span>Library</span></button>
    </div>

    <script>
        /* --- 1. CONFIG & DATA --- */
        const STORAGE_KEY = 'BaseLayer_Pro_Data'; // Permanent storage key

        const library = {
            "Air Squats": { cat: "Legs", desc: "Chest up, hips back. Deep squat.", type: "reps", val: 15, met: 5.0 },
            "Push-ups": { cat: "Upper", desc: "Core tight. Nose to floor.", type: "reps", val: 12, met: 3.8 },
            "Plank Taps": { cat: "Core", desc: "High plank. Tap opposite shoulder.", type: "reps", val: 20, met: 3.5 },
            "Glute Bridges": { cat: "Glutes", desc: "Squeeze glutes at top for 2s.", type: "reps", val: 15, met: 3.0 },
            "Rev Lunges": { cat: "Legs", desc: "Step back, drop knee gently.", type: "reps", val: 12, met: 4.5 },
            "Mtn Climbers": { cat: "Cardio", desc: "Fast pace knees to chest.", type: "time", val: 30, met: 8.0 },
            "Jumping Jacks": { cat: "Cardio", desc: "Full arm extension.", type: "time", val: 45, met: 8.0 },
            "Pigeon Pose": { cat: "Flexibility", desc: "Deep hip stretch. Breathe.", type: "time", val: 45, met: 2.0 },
            "Cat-Cow": { cat: "Mobility", desc: "Segmental spine movement.", type: "time", val: 60, met: 2.0 },
            "Dead Bug": { cat: "Core", desc: "Lower opposite arm/leg slowly.", type: "reps", val: 12, met: 3.0 },
            "Downward Dog": { cat: "Flexibility", desc: "Hips high, heels down.", type: "time", val: 45, met: 2.5 }
        };

        const routines = {
            'Strength A': { ex: ["Air Squats", "Push-ups", "Rev Lunges", "Plank Taps"], met: 5.0 },
            'Strength B': { ex: ["Rev Lunges", "Glute Bridges", "Push-ups", "Dead Bug"], met: 5.0 },
            'Cardio': { ex: ["Jumping Jacks", "Mtn Climbers", "Air Squats", "Jumping Jacks"], met: 8.0 },
            'Mobility': { ex: ["Cat-Cow", "Downward Dog", "Pigeon Pose", "Dead Bug"], met: 2.5 }
        };

        /* --- 2. STATE MANAGEMENT --- */
        let appState = {
            user: { name: "", stepGoal: 7000 },
            weightHistory: [], // [{date, lbs}]
            logs: [], // [{date, type, cals, duration}]
            weekPlan: [],
            habits: { date: null, walk: false, water: false, sleep: false },
            onboarded: false
        };

        /* --- 3. INIT & LOAD --- */
        window.onload = () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if(saved) {
                // Merge loaded data with structure to prevent crash on updates
                const loaded = JSON.parse(saved);
                appState = { ...appState, ...loaded }; 
                
                // Migrations if needed (e.g., if weight was just a number before)
                if(loaded.user && loaded.user.weight && appState.weightHistory.length === 0) {
                    appState.weightHistory.push({date: new Date().toISOString(), lbs: loaded.user.weight});
                }
            }

            // Daily Habit Reset
            const today = new Date().toISOString().split('T')[0];
            if(appState.habits.date !== today) {
                appState.habits = { date: today, walk: false, water: false, sleep: false };
            }

            if(!appState.onboarded) {
                document.getElementById('view-onboarding').classList.remove('hidden');
                document.getElementById('main-nav').classList.add('hidden');
            } else {
                initApp();
            }
        };

        function save() { 
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); 
        }

        /* --- 4. ONBOARDING (STRICT) --- */
        function finishOnboarding() {
            const n = document.getElementById('inp-name').value;
            const w = document.getElementById('inp-weight').value;
            const s = document.getElementById('inp-steps').value;

            if(!n || !w || !s) {
                document.getElementById('onboard-error').style.display = 'block';
                return;
            }

            appState.user.name = n;
            appState.user.stepGoal = parseInt(s);
            appState.weightHistory.push({ date: new Date().toISOString(), lbs: parseFloat(w) });
            appState.onboarded = true;
            
            generateWeek();
            save();
            
            document.getElementById('view-onboarding').classList.add('hidden');
            initApp();
        }

        /* --- 5. CORE APP LOGIC --- */
        function initApp() {
            document.getElementById('main-nav').classList.remove('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');
            
            // Header Info
            document.getElementById('dash-greeting').innerText = `Hi, ${appState.user.name}`;
            document.getElementById('dash-date').innerText = new Date().toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'});
            
            // Current Weight
            const lastWeight = appState.weightHistory[appState.weightHistory.length-1].lbs;
            document.getElementById('dash-weight-val').innerText = lastWeight + " lbs";
            document.getElementById('lbl-steps').innerText = `Goal: ${appState.user.stepGoal}`;

            // Calc Calories Today
            const todayStr = new Date().toISOString().split('T')[0];
            const todayLogs = appState.logs.filter(l => l.date.startsWith(todayStr));
            const totalCals = todayLogs.reduce((acc, cur) => acc + (cur.cals || 0), 0);
            document.getElementById('dash-cal').innerText = Math.round(totalCals);
            document.getElementById('dash-streak').innerText = calculateStreak();

            renderHabits();
            renderDashboard();
            renderSchedule();
            renderLibrary();
        }

        function calculateStreak() {
            // Simple logic: consecutive days with a log
            // For v4, let's just return logs.length for simplicity or add complex logic later
            return appState.logs.length; 
        }

        function getCurrentWeightKg() {
            const last = appState.weightHistory[appState.weightHistory.length-1].lbs;
            return last * 0.453592;
        }

        function calculateCalories(met, mins) {
            // Formula: Calories = (MET * 3.5 * weightInKg) / 200 * durationInMins
            const kg = getCurrentWeightKg();
            return (met * 3.5 * kg / 200) * mins;
        }

        function logWeightModal() {
            const w = prompt("Enter new weight (lbs):", appState.weightHistory[appState.weightHistory.length-1].lbs);
            if(w) {
                appState.weightHistory.push({ date: new Date().toISOString(), lbs: parseFloat(w) });
                save();
                initApp();
            }
        }

        /* --- 6. ROUTINE GENERATOR --- */
        function generateWeek() {
            const plan = [];
            const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            const today = new Date();
            
            // A/B Split + Rest Logic
            for(let i=0; i<7; i++) {
                let d = new Date();
                d.setDate(today.getDate() + i);
                let dayNum = d.getDay();
                let rKey = null;

                // Simple Cycle
                if(dayNum === 1) rKey = 'Strength A';
                else if(dayNum === 2) rKey = 'Cardio';
                else if(dayNum === 3) rKey = 'Mobility';
                else if(dayNum === 4) rKey = 'Strength B';
                else if(dayNum === 5) rKey = 'Cardio';
                else if(dayNum === 6) rKey = 'Mobility';
                // Sun (0) = Rest

                plan.push({
                    date: d.toISOString().split('T')[0],
                    dayName: days[dayNum],
                    routineKey: rKey,
                    completed: false
                });
            }
            appState.weekPlan = plan;
        }

        /* --- 7. UI RENDERERS --- */
        function renderHabits() {
            const h = appState.habits;
            document.getElementById('chk-walk').className = `habit-check ${h.walk?'checked':''}`;
            document.getElementById('chk-water').className = `habit-check ${h.water?'checked':''}`;
            document.getElementById('chk-sleep').className = `habit-check ${h.sleep?'checked':''}`;
        }
        
        function toggleHabit(k) {
            appState.habits[k] = !appState.habits[k];
            renderHabits();
            save();
        }

        function renderDashboard() {
            const todayStr = new Date().toISOString().split('T')[0];
            const task = appState.weekPlan.find(d => d.date === todayStr);
            const container = document.getElementById('today-card');
            
            if(!task || !task.routineKey) {
                container.innerHTML = `<h2 style="margin:0; color:var(--success)">Active Recovery</h2><p>Rest day. Hit your step goal.</p>`;
            } else if(task.completed) {
                container.innerHTML = `<h2 style="margin:0; color:var(--success)">Complete!</h2><p>Great work today.</p>`;
            } else {
                const r = routines[task.routineKey];
                container.innerHTML = `
                    <h2 style="margin-top:0;">${task.routineKey}</h2>
                    <p>${r.ex.length} Exercises â€¢ High Intensity</p>
                    <button class="btn btn-accent" onclick="startWorkout('${task.routineKey}')">Start Workout</button>
                `;
            }
        }

        function quickLog(type, mins, met) {
            const cals = calculateCalories(met, mins);
            appState.logs.push({ 
                date: new Date().toISOString(), 
                type: type, 
                duration: mins, 
                cals: cals 
            });
            if(type === 'Walk') { appState.habits.walk = true; renderHabits(); }
            save();
            initApp();
            alert(`Logged! Est burn: ${Math.round(cals)} cal`);
        }

        function renderSchedule() {
            const list = document.getElementById('week-list');
            list.innerHTML = "";
            const todayStr = new Date().toISOString().split('T')[0];

            appState.weekPlan.forEach(d => {
                const isToday = d.date === todayStr;
                list.innerHTML += `
                    <div style="padding:15px; border-bottom:1px solid var(--border); ${isToday?'background:rgba(255,255,255,0.05)':''}">
                        <div style="font-weight:bold; color:var(--accent);">${d.dayName}</div>
                        <div style="display:flex; justify-content:space-between;">
                            <span>${d.routineKey || "Rest Day"}</span>
                            <span>${d.completed ? '<i class="fas fa-check" style="color:var(--success)"></i>' : ''}</span>
                        </div>
                    </div>
                `;
            });
        }

        function renderLibrary() {
            const list = document.getElementById('lib-list');
            list.innerHTML = "";
            for(let k in library) {
                list.innerHTML += `
                    <div class="lib-item" data-name="${k.toLowerCase()}" style="padding:15px; border-bottom:1px solid var(--border);">
                        <div style="font-weight:bold; color:var(--text);">${k}</div>
                        <div style="font-size:0.85rem; color:var(--text-light);">${library[k].desc}</div>
                    </div>
                `;
            }
        }
        
        function filterLib(val) {
            document.querySelectorAll('.lib-item').forEach(el => {
                el.style.display = el.getAttribute('data-name').includes(val.toLowerCase()) ? 'block' : 'none';
            });
        }

        function switchTab(t) {
            document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
            document.getElementById('view-active').classList.add('hidden');
            document.getElementById('main-nav').classList.remove('hidden');
            
            if(t === 'active') {
                document.getElementById('view-active').classList.remove('hidden');
                document.getElementById('main-nav').classList.add('hidden');
            } else {
                document.getElementById('view-'+t).classList.remove('hidden');
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                // Simple active state toggle
                if(t==='dashboard') document.querySelectorAll('.nav-btn')[0].classList.add('active');
                if(t==='schedule') document.querySelectorAll('.nav-btn')[1].classList.add('active');
                if(t==='library') document.querySelectorAll('.nav-btn')[2].classList.add('active');
            }
        }

        /* --- 8. ACTIVE WORKOUT --- */
        let activeQ = [], activeIdx = 0, timer = null, timerVal = 0, currentRoutine = "";

        function startWorkout(key) {
            currentRoutine = key;
            activeQ = routines[key].ex;
            activeIdx = 0;
            switchTab('active');
            loadActive();
        }

        function loadActive() {
            if(activeIdx >= activeQ.length) return finishWorkout();
            
            const name = activeQ[activeIdx];
            const data = library[name];
            
            document.getElementById('act-progress').innerText = `${activeIdx+1} / ${activeQ.length}`;
            document.getElementById('act-cat').innerText = data.cat;
            document.getElementById('act-name').innerText = name;
            document.getElementById('act-cue').innerText = data.desc;

            const viz = document.getElementById('act-viz');
            const btn = document.getElementById('act-btn');
            clearInterval(timer);

            if(data.type === 'reps') {
                viz.innerHTML = `<div class="timer-display" style="color:var(--accent)">${data.val} <span style="font-size:2rem;color:var(--text-light)">reps</span></div>`;
                btn.innerText = "Done";
                btn.className = "btn btn-accent";
                btn.onclick = nextEx;
            } else {
                timerVal = data.val;
                viz.innerHTML = `<div class="timer-display">${timerVal}</div>`;
                btn.innerText = "Start Timer";
                btn.className = "btn btn-outline";
                btn.onclick = () => {
                    btn.innerText = "Running...";
                    timer = setInterval(() => {
                        timerVal--;
                        viz.innerHTML = `<div class="timer-display">${timerVal}</div>`;
                        if(timerVal <= 0) {
                            clearInterval(timer);
                            btn.innerText = "Next";
                            btn.className = "btn btn-accent";
                            btn.onclick = nextEx;
                        }
                    }, 1000);
                }
            }
        }

        function nextEx() { activeIdx++; loadActive(); }
        
        function quitWorkout() {
            if(confirm("Quit workout?")) { clearInterval(timer); switchTab('dashboard'); }
        }

        function finishWorkout() {
            clearInterval(timer);
            // Mark complete
            const todayStr = new Date().toISOString().split('T')[0];
            const task = appState.weekPlan.find(d => d.date === todayStr);
            if(task && task.routineKey === currentRoutine) task.completed = true;

            // Log with Calories
            const rData = routines[currentRoutine];
            const duration = 25; // Approx
            const cals = calculateCalories(rData.met, duration);
            
            appState.logs.push({ date: new Date().toISOString(), type: 'Workout', cals: cals, duration: duration });
            save();
            switchTab('dashboard');
            initApp();
            alert(`Great job! Burned approx ${Math.round(cals)} kcals.`);
        }

    </script>
</body>
</html>
