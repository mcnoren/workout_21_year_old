<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BaseLayer v3: Lifestyle</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            /* v3 Palette: Deep Navy & Vibrant Teal for a "Health Tech" feel */
            --bg: #0f172a; --card: #1e293b;
            --text: #f8fafc; --text-light: #94a3b8;
            --accent: #2dd4bf; --accent-dark: #0f766e; /* Teal */
            --secondary: #6366f1; /* Indigo for Strength */
            --success: #10b981; --danger: #f43f5e;
            --border: #334155;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }

        /* TYPOGRAPHY */
        h1 { font-size: 1.8rem; font-weight: 800; margin: 0 0 5px 0; letter-spacing: -0.5px; }
        h2 { font-size: 1.3rem; font-weight: 700; margin: 15px 0 10px 0; color: var(--text); }
        small { color: var(--text-light); font-size: 0.85rem; }

        /* UI ELEMENTS */
        .card { background: var(--card); border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2); border: 1px solid var(--border); margin-bottom: 20px; }
        
        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 10px; transition: 0.2s; }
        .btn-accent { background: var(--accent); color: #0f172a; }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text); }
        .btn:active { transform: scale(0.98); }

        .std-input { width: 100%; padding: 15px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; font-size: 1rem; color: white; margin-bottom: 10px; }

        /* DASHBOARD HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: var(--secondary); display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* DAILY HABITS SECTION */
        .habit-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .habit-row:last-child { border-bottom: none; }
        .habit-check { width: 24px; height: 24px; border-radius: 6px; border: 2px solid var(--text-light); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .habit-check.checked { background: var(--accent); border-color: var(--accent); color: var(--bg); }

        /* WORKOUT CARD */
        .workout-tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; margin-right: 5px; }
        .tag-str { background: rgba(99, 102, 241, 0.2); color: #818cf8; }
        .tag-mob { background: rgba(45, 212, 191, 0.2); color: #2dd4bf; }
        .tag-crd { background: rgba(244, 63, 94, 0.2); color: #fb7185; }

        /* LIBRARY */
        .lib-item { padding: 15px 0; border-bottom: 1px solid var(--border); }
        .lib-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .lib-cat { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-light); margin-bottom: 5px; display: block; }

        /* ACTIVE MODE */
        #view-active { position: fixed; inset: 0; background: var(--bg); z-index: 100; overflow-y: auto; }
        .active-content { padding: 20px; display: flex; flex-direction: column; min-height: 100vh; }
        .timer-display { font-size: 5rem; font-weight: 900; text-align: center; margin: 30px 0; font-variant-numeric: tabular-nums; letter-spacing: -2px; }

        /* NAV */
        .nav { position: fixed; bottom: 0; width: 100%; height: 85px; background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: space-around; z-index: 50; padding-bottom: 15px; }
        .nav-btn { flex: 1; border: none; background: none; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-light); font-size: 0.7rem; font-weight: 600; gap: 5px; }
        .nav-btn.active { color: var(--accent); }
        .nav-btn i { font-size: 1.4rem; }

    </style>
</head>
<body>

    <div id="view-onboarding" class="container hidden" style="height:100vh; display:flex; flex-direction:column; justify-content:center;">
        <h1 style="text-align:center; color:var(--accent);">BASE<span style="color:white">LAYER</span></h1>
        <p style="text-align:center; color:var(--text-light); margin-bottom:40px;">Daily habits + Targeted movement.</p>
        
        <label>First Name</label>
        <input type="text" id="inp-name" class="std-input">
        
        <label>Daily Step Goal (e.g. 7000)</label>
        <input type="number" id="inp-steps" class="std-input" value="7000">
        
        <button class="btn btn-accent" onclick="finishOnboarding()">Start My Journey</button>
    </div>

    <div id="view-dashboard" class="container hidden">
        <div class="header">
            <div>
                <h1 id="dash-greeting">Hello</h1>
                <small id="dash-date">Date</small>
            </div>
            <div class="avatar" id="user-init">U</div>
        </div>

        <div class="card">
            <h2 style="margin-top:0;">Daily Non-Negotiables</h2>
            <p style="font-size:0.9rem;">Success is what you do every day.</p>
            
            <div class="habit-row" onclick="toggleHabit('walk')">
                <div>
                    <div style="font-weight:600;">Daily Walk</div>
                    <small id="lbl-steps">0 steps</small>
                </div>
                <div class="habit-check" id="chk-walk"><i class="fas fa-check"></i></div>
            </div>

            <div class="habit-row" onclick="toggleHabit('water')">
                <div>
                    <div style="font-weight:600;">Hydration</div>
                    <small>~3 Liters</small>
                </div>
                <div class="habit-check" id="chk-water"><i class="fas fa-check"></i></div>
            </div>

            <div class="habit-row" onclick="toggleHabit('sleep')">
                <div>
                    <div style="font-weight:600;">Recovery Sleep</div>
                    <small>7+ Hours</small>
                </div>
                <div class="habit-check" id="chk-sleep"><i class="fas fa-check"></i></div>
            </div>
        </div>

        <div class="card" id="today-card">
            </div>

        <h2 style="font-size:1.1rem; margin-top:30px;">Log Activity</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="btn btn-outline" onclick="quickLog('Walk', 30)">
                <i class="fas fa-walking"></i> Walk 30m
            </button>
            <button class="btn btn-outline" onclick="quickLog('Sport', 60)">
                <i class="fas fa-futbol"></i> Sport/Gym
            </button>
        </div>
    </div>

    <div id="view-schedule" class="container hidden">
        <div class="header">
            <h1>Training Plan</h1>
        </div>
        <div class="card" id="week-list" style="padding:10px;">
            </div>
        <p style="text-align:center; font-size:0.8rem; margin-top:20px;">
            <i class="fas fa-info-circle"></i> Walks should happen every day, even on rest days.
        </p>
    </div>

    <div id="view-library" class="container hidden">
        <div class="header">
            <h1>Exercise Index</h1>
        </div>
        <input type="text" class="std-input" placeholder="Search..." onkeyup="filterLib(this.value)">
        <div id="lib-list" style="padding-bottom:100px;">
            </div>
    </div>

    <div id="view-active" class="hidden">
        <div class="active-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button class="btn btn-outline" style="width:auto; padding:10px;" onclick="quitWorkout()">
                    <i class="fas fa-times"></i>
                </button>
                <div style="text-align:right;">
                    <div style="font-size:0.8rem; text-transform:uppercase; color:var(--text-light);" id="act-routine-name">ROUTINE</div>
                    <div style="font-weight:bold;">Set <span id="act-set">1</span> / <span id="act-total">5</span></div>
                </div>
            </div>

            <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
                <div style="text-align:center;">
                    <span class="lib-tag" style="color:var(--accent); font-weight:bold; letter-spacing:1px; text-transform:uppercase;" id="act-type">Strength</span>
                    <h1 id="act-name" style="font-size:2.5rem; margin:10px 0;">Exercise Name</h1>
                </div>

                <div id="act-viz"></div> <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:15px; margin-top:20px;">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px; color:var(--accent);">
                        <i class="fas fa-lightbulb"></i> <b>Form Cue</b>
                    </div>
                    <div id="act-cue" style="line-height:1.5;">Keep chest up and core tight.</div>
                </div>
            </div>

            <button class="btn btn-accent" id="act-btn" style="padding:20px; font-size:1.2rem;" onclick="nextExercise()">Next</button>
        </div>
    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="switchTab('dashboard')">
            <i class="fas fa-home"></i><span>Today</span>
        </button>
        <button class="nav-btn" onclick="switchTab('schedule')">
            <i class="fas fa-calendar-alt"></i><span>Plan</span>
        </button>
        <button class="nav-btn" onclick="switchTab('library')">
            <i class="fas fa-dumbbell"></i><span>Library</span>
        </button>
    </div>

    <script>
        /* --- 1. EXPANDED DATABASE --- */
        
        const library = {
            // STRENGTH (Foundations)
            "Air Squats": { cat: "Legs", desc: "Feet shoulder-width. Hips back and down.", type: "reps", val: 15 },
            "Reverse Lunges": { cat: "Legs", desc: "Step BACK (easier on knees than forward). Drop back knee.", type: "reps", val: 10 },
            "Glute Bridges": { cat: "Glutes", desc: "Lying on back. Drive hips up. Squeeze glutes.", type: "reps", val: 15 },
            "Push-ups": { cat: "Upper", desc: "Hands under shoulders. Core tight. Chest to floor.", type: "reps", val: 10 },
            "Pike Push-ups": { cat: "Upper", desc: "Downward dog position. Lower head to floor. Hits shoulders.", type: "reps", val: 8 },
            "Plank Shoulder Taps": { cat: "Core", desc: "High plank. Tap opposite shoulder. No hip wiggle.", type: "reps", val: 20 },
            "Chair Dips": { cat: "Upper", desc: "Hands on chair edge. Lower body. Press up.", type: "reps", val: 10 },
            
            // CARDIO (Metabolic)
            "Jumping Jacks": { cat: "Cardio", desc: "Full range of motion arms overhead.", type: "time", val: 45 },
            "Mountain Climbers": { cat: "Cardio", desc: "Knees to chest rapidly in plank.", type: "time", val: 30 },
            "High Knees": { cat: "Cardio", desc: "Run in place, driving knees to waist height.", type: "time", val: 30 },
            "Skater Hops": { cat: "Cardio", desc: "Hop side to side landing on one foot.", type: "time", val: 30 },

            // FLEXIBILITY & MOBILITY (New Request)
            "Cat-Cow Flow": { cat: "Mobility", desc: "Hands & knees. Arch back (inhale), Round spine (exhale).", type: "time", val: 60 },
            "World's Greatest Stretch": { cat: "Mobility", desc: "Deep lunge, rotate arm to ceiling. Alternate sides.", type: "reps", val: 6 },
            "Pigeon Pose": { cat: "Flexibility", desc: "One leg bent in front, one straight back. Lean forward.", type: "time", val: 45 },
            "Downward Dog": { cat: "Flexibility", desc: "Hips high, heels to floor. Pedal feet.", type: "time", val: 45 },
            "Dead Bug": { cat: "Core/Stability", desc: "Back on floor. Extend opposite arm/leg slowly.", type: "reps", val: 12 },
            "Child's Pose to Cobra": { cat: "Mobility", desc: "Sit back on heels, then glide forward hips down.", type: "time", val: 60 },
            "90/90 Hip Switch": { cat: "Mobility", desc: "Sit on floor. Rotate knees side to side.", type: "reps", val: 10 }
        };

        const routines = {
            'Strength A': { 
                tag: 'str', desc: 'Full Body Foundations', 
                ex: ["Air Squats", "Push-ups", "Reverse Lunges", "Plank Shoulder Taps", "Glute Bridges"] 
            },
            'Strength B': { 
                tag: 'str', desc: 'Posterior & Shoulders', 
                ex: ["Reverse Lunges", "Pike Push-ups", "Chair Dips", "World's Greatest Stretch", "Air Squats"] 
            },
            'Cardio Burn': { 
                tag: 'crd', desc: 'Heart Health', 
                ex: ["Jumping Jacks", "Mountain Climbers", "Air Squats", "Skater Hops", "High Knees"] 
            },
            'Deep Mobility': { 
                tag: 'mob', desc: 'Flexibility Focus', 
                ex: ["Cat-Cow Flow", "Downward Dog", "World's Greatest Stretch", "Pigeon Pose", "Child's Pose to Cobra"] 
            },
            'Active Flow': { 
                tag: 'mob', desc: 'Movement Health', 
                ex: ["Dead Bug", "Glute Bridges", "Cat-Cow Flow", "90/90 Hip Switch"] 
            }
        };

        /* --- 2. STATE --- */
        let appState = {
            user: { name: "User", stepGoal: 7000 },
            habits: { date: null, walk: false, water: false, sleep: false }, // Reset daily
            weekPlan: [],
            logs: []
        };

        /* --- 3. LOGIC --- */
        window.onload = () => {
            const saved = localStorage.getItem('BaseLayer_v3');
            if(saved) appState = JSON.parse(saved);

            // Habit Date Check
            const today = new Date().toISOString().split('T')[0];
            if(appState.habits.date !== today) {
                appState.habits = { date: today, walk: false, water: false, sleep: false };
            }

            if(!appState.user.name || appState.user.name === "User") {
                document.getElementById('view-onboarding').classList.remove('hidden');
            } else {
                checkSchedule();
                initApp();
            }
        };

        function save() { localStorage.setItem('BaseLayer_v3', JSON.stringify(appState)); }

        function finishOnboarding() {
            const n = document.getElementById('inp-name').value;
            const s = document.getElementById('inp-steps').value;
            if(n) appState.user.name = n;
            if(s) appState.user.stepGoal = s;
            
            generateWeek();
            save();
            document.getElementById('view-onboarding').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');
            initApp();
        }

        /* --- GENERATE SOPHISTICATED SCHEDULE --- */
        function generateWeek() {
            const plan = [];
            const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            const today = new Date();
            
            // Rotation Logic: A/B splits
            for(let i=0; i<7; i++) {
                let d = new Date();
                d.setDate(today.getDate() + i);
                let dayNum = d.getDay();
                let rKey = null;

                // Mon: Strength A, Tue: Cardio, Wed: Deep Mobility
                // Thu: Strength B, Fri: Cardio, Sat: Active Flow, Sun: Rest (Walk only)
                if(dayNum === 1) rKey = 'Strength A';
                else if(dayNum === 2) rKey = 'Cardio Burn';
                else if(dayNum === 3) rKey = 'Deep Mobility';
                else if(dayNum === 4) rKey = 'Strength B';
                else if(dayNum === 5) rKey = 'Cardio Burn';
                else if(dayNum === 6) rKey = 'Active Flow';
                // Sunday is strict rest (no routine, just habits)

                plan.push({
                    date: d.toISOString().split('T')[0],
                    dayName: days[dayNum],
                    routineKey: rKey,
                    completed: false
                });
            }
            appState.weekPlan = plan;
        }

        function checkSchedule() {
            if(!appState.weekPlan.length) generateWeek();
            // In a real app, handle week roll-over here
        }

        function initApp() {
            document.getElementById('dash-greeting').innerText = `Hello, ${appState.user.name}`;
            document.getElementById('user-init').innerText = appState.user.name.charAt(0).toUpperCase();
            document.getElementById('dash-date').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            document.getElementById('lbl-steps').innerText = `${appState.user.stepGoal} steps`;

            renderHabits();
            renderDashboard();
            renderSchedule();
            renderLibrary();
        }

        /* --- DASHBOARD & HABITS --- */
        function renderHabits() {
            const h = appState.habits;
            updateCheck('walk', h.walk);
            updateCheck('water', h.water);
            updateCheck('sleep', h.sleep);
        }

        function updateCheck(id, status) {
            const el = document.getElementById(`chk-${id}`);
            if(status) el.classList.add('checked');
            else el.classList.remove('checked');
        }

        function toggleHabit(key) {
            appState.habits[key] = !appState.habits[key];
            renderHabits();
            save();
        }

        function renderDashboard() {
            const todayStr = new Date().toISOString().split('T')[0];
            const task = appState.weekPlan.find(d => d.date === todayStr);
            const container = document.getElementById('today-card');

            if(!task || !task.routineKey) {
                // Rest Day Logic
                container.innerHTML = `
                    <div style="text-align:center; padding:10px;">
                        <h2 style="color:var(--accent); margin-bottom:5px;">Active Recovery</h2>
                        <p>No formal workout today. Focus on your Daily Non-Negotiables (Walk + Sleep).</p>
                        <button class="btn btn-outline" onclick="startWorkout('Deep Mobility')">Optional Stretching</button>
                    </div>
                `;
            } else if (task.completed) {
                container.innerHTML = `
                    <div style="text-align:center; padding:10px;">
                        <div style="color:var(--success); font-size:3rem; margin-bottom:10px;"><i class="fas fa-check-circle"></i></div>
                        <h2>Session Complete</h2>
                        <p>Great job. Don't forget your daily walk.</p>
                    </div>
                `;
            } else {
                const r = routines[task.routineKey];
                let tagClass = r.tag === 'str' ? 'tag-str' : (r.tag === 'mob' ? 'tag-mob' : 'tag-crd');
                
                container.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <span class="workout-tag ${tagClass}">${task.routineKey}</span>
                            <h2 style="margin-top:10px;">${r.desc}</h2>
                            <small>${r.ex.length} Exercises â€¢ ~25 Mins</small>
                        </div>
                    </div>
                    <div style="margin-top:20px;">
                        <button class="btn btn-accent" onclick="startWorkout('${task.routineKey}')">Start Session</button>
                    </div>
                `;
            }
        }

        function quickLog(type, mins) {
            appState.logs.push({ date: new Date().toISOString(), type: type, duration: mins });
            if(type === 'Walk') {
                appState.habits.walk = true;
                renderHabits();
            }
            save();
            alert(`${type} logged!`);
        }

        /* --- SCHEDULE VIEW --- */
        function renderSchedule() {
            const list = document.getElementById('week-list');
            list.innerHTML = "";
            const todayStr = new Date().toISOString().split('T')[0];

            appState.weekPlan.forEach(day => {
                const isToday = day.date === todayStr;
                const r = routines[day.routineKey];
                const title = day.routineKey || "Active Recovery";
                const desc = r ? r.desc : "Steps & Habits";
                const icon = day.completed ? '<i class="fas fa-check-circle" style="color:var(--success)"></i>' : (isToday ? '<i class="fas fa-dot-circle" style="color:var(--accent)"></i>' : '');

                list.innerHTML += `
                    <div style="display:flex; align-items:center; padding:15px 0; border-bottom:1px solid var(--border); ${isToday ? 'background:rgba(255,255,255,0.03); margin:-10px; padding:20px; border-radius:10px;' : 'opacity:0.7;'}">
                        <div style="width:50px; text-align:center; font-weight:bold; color:var(--text-light);">${day.dayName}</div>
                        <div style="flex:1;">
                            <div style="font-weight:bold; ${isToday?'color:var(--accent);':''}">${title}</div>
                            <small>${desc}</small>
                        </div>
                        <div style="font-size:1.2rem;">${icon}</div>
                    </div>
                `;
            });
        }

        /* --- LIBRARY VIEW --- */
        function renderLibrary() {
            const list = document.getElementById('lib-list');
            list.innerHTML = "";
            // Sort by Category
            const keys = Object.keys(library).sort((a,b) => library[a].cat.localeCompare(library[b].cat));
            
            keys.forEach(k => {
                const item = library[k];
                list.innerHTML += `
                    <div class="lib-item" data-name="${k.toLowerCase()}">
                        <span class="lib-cat">${item.cat}</span>
                        <div style="font-weight:bold; font-size:1.1rem; margin-bottom:5px;">${k}</div>
                        <div style="color:var(--text-light); font-size:0.9rem;">${item.desc}</div>
                    </div>
                `;
            });
        }

        function filterLib(val) {
            const items = document.querySelectorAll('.lib-item');
            items.forEach(i => {
                if(i.getAttribute('data-name').includes(val.toLowerCase())) i.style.display = 'block';
                else i.style.display = 'none';
            });
        }

        /* --- WORKOUT ENGINE --- */
        let activeQ = [];
        let activeIdx = 0;
        let timer = null;
        let timerVal = 0;
        let isPaused = false;
        let currentRoutineName = "";

        function startWorkout(key) {
            currentRoutineName = key;
            const r = routines[key];
            activeQ = r.ex;
            activeIdx = 0;
            
            switchTab('active');
            document.getElementById('view-dashboard').classList.add('hidden'); // Ensure hidden
            document.getElementById('view-active').classList.remove('hidden');
            
            document.getElementById('act-routine-name').innerText = key;
            document.getElementById('act-total').innerText = activeQ.length;
            
            loadActiveEx();
        }

        function loadActiveEx() {
            if(activeIdx >= activeQ.length) return finishWorkout();
            
            const name = activeQ[activeIdx];
            const data = library[name];
            
            document.getElementById('act-set').innerText = activeIdx + 1;
            document.getElementById('act-name').innerText = name;
            document.getElementById('act-cue').innerText = data.desc;
            document.getElementById('act-type').innerText = data.cat; // Show category as tag

            const viz = document.getElementById('act-viz');
            const btn = document.getElementById('act-btn');
            clearInterval(timer);

            if(data.type === 'reps') {
                viz.innerHTML = `<div class="timer-display" style="color:var(--accent)">${data.val}<span style="font-size:2rem; color:var(--text-light); margin-left:10px;">reps</span></div>`;
                btn.innerText = "Complete Set";
                btn.className = "btn btn-accent";
                btn.onclick = nextExercise;
            } else {
                timerVal = data.val;
                isPaused = false;
                viz.innerHTML = `<div class="timer-display" id="timer-val">00:${timerVal}</div>`;
                btn.innerText = "Start Timer";
                btn.className = "btn btn-outline";
                btn.style.color = "var(--text)";
                btn.onclick = toggleTimer;
            }
        }

        function toggleTimer() {
            const btn = document.getElementById('act-btn');
            if(btn.innerText === "Start Timer" || btn.innerText === "Resume") {
                btn.innerText = "Pause";
                btn.className = "btn btn-outline"; // Keep outline while running
                startLoop();
            } else {
                isPaused = true;
                btn.innerText = "Resume";
            }
        }

        function startLoop() {
            isPaused = false;
            timer = setInterval(() => {
                if(!isPaused) {
                    timerVal--;
                    document.getElementById('timer-val').innerText = `00:${timerVal.toString().padStart(2,'0')}`;
                    if(timerVal <= 0) {
                        clearInterval(timer);
                        const btn = document.getElementById('act-btn');
                        btn.innerText = "Next Exercise";
                        btn.className = "btn btn-accent"; // Turn accent when done
                        btn.onclick = nextExercise;
                        // Audio chime could go here
                    }
                }
            }, 1000);
        }

        function nextExercise() {
            activeIdx++;
            loadActiveEx();
        }

        function quitWorkout() {
            if(confirm("Quit session?")) {
                clearInterval(timer);
                switchTab('dashboard');
            }
        }

        function finishWorkout() {
            clearInterval(timer);
            const todayStr = new Date().toISOString().split('T')[0];
            const task = appState.weekPlan.find(d => d.date === todayStr);
            
            // Only mark completed if it was today's assigned workout
            if(task && task.routineKey === currentRoutineName) {
                task.completed = true;
            }
            
            appState.logs.push({date: new Date().toISOString(), type: 'Workout', routine: currentRoutineName});
            save();
            switchTab('dashboard');
            initApp(); // Refresh UI
            alert("Workout Complete!");
        }

        function switchTab(t) {
            document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
            document.getElementById('view-active').classList.add('hidden');
            
            if(t === 'active') {
                document.getElementById('view-active').classList.remove('hidden');
                // Hide nav when active
                document.querySelector('.nav').classList.add('hidden');
            } else {
                document.getElementById(`view-${t}`).classList.remove('hidden');
                document.querySelector('.nav').classList.remove('hidden');
                
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                const map = {'dashboard':0, 'schedule':1, 'library':2};
                if(map[t] !== undefined) document.querySelectorAll('.nav-btn')[map[t]].classList.add('active');
            }
        }

    </script>
</body>
</html>
